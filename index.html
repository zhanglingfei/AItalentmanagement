<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERABOX AI人才案件匹配管理数据查看器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 2170px;
            width: 95%;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 3px solid #dc2626;
        }

        .header {
            background: linear-gradient(45deg, #dc2626, #991b1b);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            background: #f8f9fa;
            border-bottom: 3px solid #dc2626;
            display: flex;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: #e5e7eb;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #d1d5db;
            min-width: 200px;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: linear-gradient(45deg, #dc2626, #991b1b);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: #d1d5db;
            color: #1f2937;
        }

        .tab-button:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Config Section */
        .config-section {
            background: #fffbeb;
            padding: 25px;
            border-bottom: 2px solid #dc2626;
        }

        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: #ffffff;
        }

        .form-group input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .load-btn {
            background: linear-gradient(45deg, #dc2626, #991b1b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            grid-column: 1 / -1;
            justify-self: center;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .load-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #374151;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fde68a;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #fca5a5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            border: 2px solid #fbbf24;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filters {
            background: #fffbeb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
            border: 2px solid #fbbf24;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #1f2937;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 2px solid #fbbf24;
            border-radius: 6px;
            font-size: 14px;
            background: #ffffff;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #dc2626;
        }

        .filter-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: 38px;
            transition: background-color 0.3s ease;
        }

        .filter-btn:hover {
            background: #991b1b;
        }

        .clear-btn {
            background: #374151;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            height: 38px;
            transition: background-color 0.3s ease;
        }

        .clear-btn:hover {
            background: #1f2937;
        }

        .table-container {
            max-height: 600px;
            overflow: auto;
            border-radius: 8px;
            border: 3px solid #dc2626;
            margin-top: 20px;
            background: #ffffff;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: linear-gradient(45deg, #1f2937, #374151);
            color: #fbbf24;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            white-space: nowrap;
            border-bottom: 2px solid #dc2626;
            min-width: 120px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #fde68a;
            transition: background-color 0.2s ease;
            font-size: 13px;
            color: #1f2937;
            vertical-align: top;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
            min-width: 120px;
            max-width: 500px;
        }

        .data-table tr:hover td {
            background-color: #fef3c7;
        }

        .data-table tr:nth-child(even) td {
            background-color: #fffbeb;
        }

        /* Specific column styles */
        .processed-status {
            text-align: center;
            font-weight: bold;
            min-width: 100px;
        }

        .processed-yes {
            color: #dc2626;
        }

        .processed-no {
            color: #374151;
        }

        .work-rate {
            text-align: right;
            font-weight: 600;
            color: #dc2626;
            min-width: 120px;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .project-id {
            font-family: 'Courier New', monospace;
            background: #fde68a;
            color: #1f2937;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            word-break: break-all;
        }

        .email-cell {
            min-width: 200px;
            max-width: 250px;
            word-break: break-all;
        }

        .timestamp {
            font-size: 12px;
            color: #6b7280;
            min-width: 120px;
        }

        .contact-info {
            min-width: 150px;
            max-width: 200px;
            word-break: break-word;
        }

        .email-subject {
            min-width: 250px;
            max-width: 400px;
            font-style: italic;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .project-title {
            min-width: 250px;
            max-width: 400px;
            font-weight: 600;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .project-description {
            min-width: 300px;
            max-width: 500px;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .refresh-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }

        .refresh-btn:hover {
            background: #991b1b;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .export-btn {
            background: #f59e0b;
            color: #1f2937;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .export-btn:hover {
            background: #d97706;
        }

        /* Pagination Styles */
        .pagination-container {
            background: #fffbeb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #fbbf24;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #374151;
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #991b1b;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-btn.active {
            background: #f59e0b;
            color: #1f2937;
        }

        .pagination-btn.active:hover {
            background: #d97706;
        }

        .pagination-first {
            background: #374151;
        }

        .pagination-first:hover:not(:disabled) {
            background: #1f2937;
        }

        .pagination-last {
            background: #374151;
        }

        .pagination-last:hover:not(:disabled) {
            background: #1f2937;
        }

        .page-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid #fbbf24;
        }

        .page-input-container label {
            font-size: 12px;
            color: #374151;
            font-weight: 600;
            white-space: nowrap;
        }

        .page-input {
            width: 50px;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .page-input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .page-size-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid #fbbf24;
        }

        .page-size-container label {
            font-size: 12px;
            color: #374151;
            font-weight: 600;
            white-space: nowrap;
        }

        .page-size-select {
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .page-size-select:focus {
            outline: none;
            border-color: #dc2626;
        }

        /* Talent database specific styles */
        .talent-id {
            font-family: 'Courier New', monospace;
            background: #e0f2fe;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .skill-tag {
            background: #e1f5fe;
            color: #01579b;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .experience-years {
            font-weight: bold;
            color: #2e7d32;
        }

        /* Matching results specific styles */
        .match-score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }

        .match-score.high {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .match-score.medium {
            background: #fff3e0;
            color: #e65100;
        }

        .match-score.low {
            background: #ffebee;
            color: #c62828;
        }

        .match-details {
            max-width: 300px;
            font-size: 12px;
            line-height: 1.3;
        }

        /* Compact Match Details Styles */
.match-details-compact {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px 10px;
    margin: 2px 0;
    max-width: 300px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    font-size: 12px;
    line-height: 1.3;
    color: #374151;
    cursor: help;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
}

.match-details-compact::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #dc2626, #991b1b);
    border-radius: 6px 0 0 6px;
}

.match-details-compact:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-color: #dc2626;
    box-shadow: 0 2px 6px rgba(220, 38, 38, 0.15);
    transform: translateY(-1px);
    white-space: normal;
    overflow: visible;
    z-index: 10;
    position: relative;
}

.match-details-compact.match-error {
    background: #fef2f2;
    border-color: #fecaca;
    color: #dc2626;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .match-details-compact {
        max-width: 200px;
        font-size: 11px;
        padding: 6px 8px;
    }
}
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
                width: 98%;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .tab-button {
                min-width: 150px;
                font-size: 14px;
                padding: 12px 15px;
            }

            .config-form {
                grid-template-columns: 1fr;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 12px;
            }

            /* 调整表格单元格的最小宽度以适应新字段 */
            .data-table th,
            .data-table td {
                padding: 12px;
                border-bottom: 1px solid #fde68a;
                transition: background-color 0.2s ease;
                font-size: 13px;
                color: #1f2937;
                vertical-align: top;
                word-wrap: break-word;
                white-space: pre-wrap;
                line-height: 1.4;
                min-width: 100px; /* 减小最小宽度以适应更多列 */
                max-width: 300px; /* 减小最大宽度 */
            }

            /* 特定字段的宽度控制 */
            .data-table th:nth-child(1),
            .data-table td:nth-child(1) {
                min-width: 120px; /* Processed At */
            }
            
            .data-table th:nth-child(3),
            .data-table td:nth-child(3) {
                min-width: 200px; /* Email Subject */
            }
            
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                min-width: 120px; /* Project ID */
            }
            
            .data-table th:nth-child(5),
            .data-table td:nth-child(5) {
                min-width: 200px; /* Project Title */
            }
            
            .data-table th:nth-child(6),
            .data-table td:nth-child(6) {
                min-width: 250px; /* Project Description */
            }
            
            .data-table th:nth-child(11),
            .data-table td:nth-child(11) {
                min-width: 100px; /* Project Type */
            }
            
            .data-table th:nth-child(12),
            .data-table td:nth-child(12) {
                min-width: 150px; /* Tech Requirements */
            }

            .table-container {
                max-height: 500px;
            }

            /* 新增的项目字段样式 */
            .project-type {
                background: #f3e8ff;
                color: #7c3aed;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                display: inline-block;
                word-break: break-word;
            }
            
            .project-duration {
                background: #fef3c7;
                color: #92400e;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                display: inline-block;
                min-width: 80px;
                text-align: center;
            }
            
            .work-style {
                background: #ecfdf5;
                color: #065f46;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
                display: inline-block;
            }
            
            .client-company {
                background: #eff6ff;
                color: #1e40af;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                display: inline-block;
                word-break: break-word;
            }
            
            .urgency {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
                display: inline-block;
                text-align: center;
                min-width: 60px;
            }
            
            .urgency.urgent {
                background: #fee2e2;
                color: #dc2626;
                animation: pulse 2s infinite;
            }
            
            .urgency.normal {
                background: #f0f9ff;
                color: #0284c7;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            .special-requirements {
                min-width: 200px;
                max-width: 300px;
                word-break: break-word;
                white-space: pre-wrap;
                line-height: 1.4;
                font-size: 13px;
                color: #374151;
                background: #fafafa;
                padding: 6px;
                border-radius: 4px;
                border-left: 3px solid #f59e0b;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 TERABOX AI人才案件匹配管理数据查看器</h1>
            <p>项目进度追踪与工作记录管理系统</p>
        </div>

        <!-- Configuration Section -->
        <div class="config-section" id="configSection">
            <div class="config-form">
                <div class="form-group">
                    <label for="apiKey">Google API 密钥:</label>
                    <input type="text" id="apiKey" placeholder="输入您的Google Sheets API密钥">
                </div>
                <div class="form-group">
                    <label for="sheetId">Google Sheets表格ID:</label>
                    <input type="text" id="sheetId" placeholder="包含所有数据的Google Sheets表格ID">
                </div>
                <button class="load-btn" onclick="authenticateAndLoad()">🔄 认证并加载数据</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tabNavigation" style="display: none;">
            <button class="tab-button active" onclick="switchTab('case')" id="caseTab">📋 案件数据库</button>
            <button class="tab-button" onclick="switchTab('talent')" id="talentTab">👥 人才数据库</button>
            <button class="tab-button" onclick="switchTab('matching')" id="matchingTab">🎯 匹配结果一览</button>
        </div>

        <!-- Case Database Tab -->
        <div class="tab-content active" id="caseContent">
            <div id="caseLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>正在加载案件数据...</p>
            </div>

            <div id="caseError" class="error" style="display: none;"></div>

            <div id="caseStats" class="stats" style="display: none;"></div>

            <div id="caseDataContainer" style="display: none;">
                <div id="caseFilters" class="filters">
                    <div class="filter-group">
                        <label for="caseProcessedFilter">处理状态:</label>
                        <select id="caseProcessedFilter">
                            <option value="">全部</option>
                            <option value="已处理">已处理</option>
                            <option value="未处理">未处理</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="caseProjectFilter">项目ID:</label>
                        <input type="text" id="caseProjectFilter" placeholder="搜索项目ID...">
                    </div>
                    <div class="filter-group">
                        <label for="caseContactFilter">联系人:</label>
                        <input type="text" id="caseContactFilter" placeholder="搜索联系人...">
                    </div>
                    <div class="filter-group">
                        <label for="caseDateFilter">日期范围:</label>
                        <input type="date" id="caseDateFilter">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="applyFilters('case')">🔍 筛选</button>
                    </div>
                    <div class="filter-group">
                        <button class="clear-btn" onclick="clearFilters('case')">🔄 清除</button>
                    </div>
                </div>

                <div class="toolbar">
                    <h3>📈 案件数据表格</h3>
                    <div>
                        <button class="export-btn" onclick="exportToCSV('case')">📥 导出CSV</button>
                        <button class="refresh-btn" onclick="loadData('case')">🔄 刷新数据</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="caseDataTable"></table>
                </div>

                <div class="pagination-container" id="casePagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="casePaginationInfo">显示第 1-3 条，共 0 条记录</span>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-size-container">
                            <label>每页:</label>
                            <select class="page-size-select" id="casePageSize" onchange="changePageSize('case')">
                                <option value="3">3条</option>
                                <option value="5">5条</option>
                                <option value="10">10条</option>
                                <option value="20">20条</option>
                                <option value="50">50条</option>
                            </select>
                        </div>
                        <button class="pagination-btn pagination-first" onclick="goToPage('case', 1)" id="caseFirstBtn">首页</button>
                        <button class="pagination-btn" onclick="previousPage('case')" id="casePrevBtn">上一页</button>
                        <div class="page-input-container">
                            <label>第</label>
                            <input type="number" class="page-input" id="casePageInput" min="1" onchange="goToPageInput('case')" onkeypress="handlePageInputEnter(event, 'case')">
                            <label>页</label>
                        </div>
                        <button class="pagination-btn" onclick="nextPage('case')" id="caseNextBtn">下一页</button>
                        <button class="pagination-btn pagination-last" onclick="goToLastPage('case')" id="caseLastBtn">末页</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Talent Database Tab -->
        <div class="tab-content" id="talentContent">
            <div id="talentLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>正在加载人才数据...</p>
            </div>

            <div id="talentError" class="error" style="display: none;"></div>

            <div id="talentStats" class="stats" style="display: none;"></div>

            <div id="talentDataContainer" style="display: none;">
                <div id="talentFilters" class="filters">
                    <div class="filter-group">
                        <label for="talentSkillFilter">技术技能:</label>
                        <input type="text" id="talentSkillFilter" placeholder="搜索技能...">
                    </div>
                    <div class="filter-group">
                        <label for="talentLocationFilter">工作地点:</label>
                        <input type="text" id="talentLocationFilter" placeholder="搜索地点...">
                    </div>
                    <div class="filter-group">
                        <label for="talentExperienceFilter">经验年限:</label>
                        <select id="talentExperienceFilter">
                            <option value="">全部</option>
                            <option value="0-2">0-2年</option>
                            <option value="3-5">3-5年</option>
                            <option value="6-10">6-10年</option>
                            <option value="10+">10年以上</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="talentNameFilter">姓名:</label>
                        <input type="text" id="talentNameFilter" placeholder="搜索姓名...">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="applyFilters('talent')">🔍 筛选</button>
                    </div>
                    <div class="filter-group">
                        <button class="clear-btn" onclick="clearFilters('talent')">🔄 清除</button>
                    </div>
                </div>

                <div class="toolbar">
                    <h3>👥 人才数据表格</h3>
                    <div>
                        <button class="export-btn" onclick="exportToCSV('talent')">📥 导出CSV</button>
                        <button class="refresh-btn" onclick="loadData('talent')">🔄 刷新数据</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="talentDataTable"></table>
                </div>

                <div class="pagination-container" id="talentPagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="talentPaginationInfo">显示第 1-3 条，共 0 条记录</span>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-size-container">
                            <label>每页:</label>
                            <select class="page-size-select" id="talentPageSize" onchange="changePageSize('talent')">
                                <option value="3">3条</option>
                                <option value="5">5条</option>
                                <option value="10">10条</option>
                                <option value="20">20条</option>
                                <option value="50">50条</option>
                            </select>
                        </div>
                        <button class="pagination-btn pagination-first" onclick="goToPage('talent', 1)" id="talentFirstBtn">首页</button>
                        <button class="pagination-btn" onclick="previousPage('talent')" id="talentPrevBtn">上一页</button>
                        <div class="page-input-container">
                            <label>第</label>
                            <input type="number" class="page-input" id="talentPageInput" min="1" onchange="goToPageInput('talent')" onkeypress="handlePageInputEnter(event, 'talent')">
                            <label>页</label>
                        </div>
                        <button class="pagination-btn" onclick="nextPage('talent')" id="talentNextBtn">下一页</button>
                        <button class="pagination-btn pagination-last" onclick="goToLastPage('talent')" id="talentLastBtn">末页</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matching Results Tab -->
        <div class="tab-content" id="matchingContent">
            <div id="matchingLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>正在加载匹配结果...</p>
            </div>

            <div id="matchingError" class="error" style="display: none;"></div>

            <div id="matchingStats" class="stats" style="display: none;"></div>

            <div id="matchingDataContainer" style="display: none;">
                <div id="matchingFilters" class="filters">
                    <div class="filter-group">
                        <label for="matchingTalentFilter">人才ID:</label>
                        <input type="text" id="matchingTalentFilter" placeholder="搜索人才ID...">
                    </div>
                
                    <div class="filter-group">
                        <label for="matchingScoreFilter">最低匹配分数:</label>
                        <input type="number" id="matchingScoreFilter" placeholder="例如: 80" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label for="matchingDateFilter">匹配日期:</label>
                        <input type="date" id="matchingDateFilter">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="applyFilters('matching')">🔍 筛选</button>
                    </div>
                    <div class="filter-group">
                        <button class="clear-btn" onclick="clearFilters('matching')">🔄 清除</button>
                    </div>
                </div>

                <div class="toolbar">
                    <h3>🎯 匹配结果表格</h3>
                    <div>
                        <button class="export-btn" onclick="exportToCSV('matching')">📥 导出CSV</button>
                        <button class="refresh-btn" onclick="loadData('matching')">🔄 刷新数据</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="matchingDataTable"></table>
                </div>

                <div class="pagination-container" id="matchingPagination" style="display: none;">
                    <div class="pagination-info">
                        <span id="matchingPaginationInfo">显示第 1-3 条，共 0 条记录</span>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-size-container">
                            <label>每页:</label>
                            <select class="page-size-select" id="matchingPageSize" onchange="changePageSize('matching')">
                                <option value="3">3条</option>
                                <option value="5">5条</option>
                                <option value="10">10条</option>
                                <option value="20">20条</option>
                                <option value="50">50条</option>
                            </select>
                        </div>
                        <button class="pagination-btn pagination-first" onclick="goToPage('matching', 1)" id="matchingFirstBtn">首页</button>
                        <button class="pagination-btn" onclick="previousPage('matching')" id="matchingPrevBtn">上一页</button>
                        <div class="page-input-container">
                            <label>第</label>
                            <input type="number" class="page-input" id="matchingPageInput" min="1" onchange="goToPageInput('matching')" onkeypress="handlePageInputEnter(event, 'matching')">
                            <label>页</label>
                        </div>
                        <button class="pagination-btn" onclick="nextPage('matching')" id="matchingNextBtn">下一页</button>
                        <button class="pagination-btn pagination-last" onclick="goToLastPage('matching')" id="matchingLastBtn">末页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {
            case: [],
            talent: [],
            matching: []
        };
        let filteredData = {
            case: [],
            talent: [],
            matching: []
        };
        let currentPage = {
            case: 1,
            talent: 1,
            matching: 1
        };
        let recordsPerPage = 3;
        let isAuthenticated = false;
        
        // Column mappings for different tabs
        const columnMappings = {
            case: {
                'Processed At': 0,
                'Email Timestamp': 1,
                'Email Subject': 2,
                'Project ID': 3,
                'Project Title': 4,
                'Project Description': 5,
                'Work Rate': 6,
                'Start Time': 7,
                'Contact Person': 8,
                'Contact Information': 9,
                'Project Type': 10,
                'Tech Requirements': 11,
                'Duration': 12,
                'Work Style': 13,
                'Client Company': 14,
                'Urgency': 15,
                'Special Requirements': 16
            },
            talent: {
                '分析日期': 0,
                'PDF 文件名': 1,
                'Resume ID': 2,
                '全名': 3,
                '职业头衔': 4,
                '工作经验年限': 5,
                '技术技能': 6,
                '证书': 7,
                '教育背景': 8,
                '先前雇主': 9,
                '主要项目': 10,
                '首选工作地点': 11,
                '语言能力': 12,
                '联系邮箱': 13,
                'LinkedIn 或个人网站': 14
            },
            matching: {
                'Match_Date': 0,
                'Talent_ID': 1,
                'Talent_Name': 2,
                'Match 1 Score': 3,
                'Match 1 Name': 4,
                'Match 2 Score': 5,
                'Match 2 Name': 6,
                'Match 3 Score': 7,
                'Match 3 Name': 8,
                'Match Details': 9
            }
        };
        // Predefined headers for each tab
        const predefinedHeaders = {
            case: [
                'Processed At', 'Email Timestamp', 'Email Subject', 'Project ID',
                'Project Title', 'Project Description', 'Work Rate', 'Start Time',
                'Contact Person', 'Contact Information', 'Project Type',
                'Tech Requirements', 'Duration', 'Work Style', 'Client Company',
                'Urgency', 'Special Requirements'
            ],
            talent: [
                '分析日期', 'PDF 文件名', 'Resume ID', '全名', '职业头衔',
                '工作经验年限', '技术技能', '证书', '教育背景', '先前雇主',
                '主要项目', '首选工作地点', '语言能力', '联系邮箱', 'LinkedIn 或个人网站'
            ],
            matching: [
                'Match_Date', 'Talent_ID', 'Talent_Name',
                'Match 1 Score', 'Match 1 Name',
                'Match 2 Score', 'Match 2 Name',
                'Match 3 Score', 'Match 3 Name', 'Match Details'
            ]
        };

        // Sheet names configuration
        const sheetNames = {
            case: 'projects',
            talent: 'resume_database',
            matching: 'matches'
        };

        // Load configuration from localStorage
        function loadConfig() {
            const apiKey = localStorage.getItem('projectMgmtApiKey');
            const sheetId = localStorage.getItem('projectMgmtSheetId');

            if (apiKey) document.getElementById('apiKey').value = apiKey;
            if (sheetId) document.getElementById('sheetId').value = sheetId;
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('projectMgmtApiKey', document.getElementById('apiKey').value);
            localStorage.setItem('projectMgmtSheetId', document.getElementById('sheetId').value);
        }

        // Auto-detect data range for a sheet
        async function detectSheetRange(apiKey, sheetId, sheetName) {
            try {
                // First, get basic sheet info to determine dimensions
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?key=${apiKey}`;
                const metadataResponse = await fetch(metadataUrl);
                
                if (!metadataResponse.ok) {
                    throw new Error(`无法获取表格信息: ${metadataResponse.status}`);
                }
                
                const metadata = await metadataResponse.json();
                const sheet = metadata.sheets.find(s => s.properties.title === sheetName);
                
                if (!sheet) {
                    throw new Error(`未找到名为 "${sheetName}" 的工作表`);
                }
                
                const gridProperties = sheet.properties.gridProperties;
                const maxRows = Math.min(gridProperties.rowCount || 1000, 1000);
                const maxCols = Math.min(gridProperties.columnCount || 26, 26);
                
                // Convert column number to letter (A, B, C, ... Z)
                const getColumnLetter = (colNum) => {
                    return String.fromCharCode(65 + colNum - 1);
                };
                
                const endColumn = getColumnLetter(maxCols);
                const range = `${sheetName}!A1:${endColumn}${maxRows}`;
                
                console.log(`检测到的数据范围: ${range}`);
                return range;
                
            } catch (error) {
                console.error(`检测工作表范围时出错:`, error);
                // Fallback to default range
                return `${sheetName}!A1:Z1000`;
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            if (!isAuthenticated) return;

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load data if not already loaded
            if (currentData[tabName].length === 0) {
                loadData(tabName);
            } else {
                // Reset pagination when switching tabs
                currentPage[tabName] = 1;
                renderTable(tabName, filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName]);
            }
        }

        // Authenticate and load initial data
        async function authenticateAndLoad() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sheetId = document.getElementById('sheetId').value.trim();

            if (!apiKey || !sheetId) {
                showError('case', '请输入Google API密钥和表格ID');
                return;
            }

            saveConfig();
            
            try {
                // Test authentication with case database first
                console.log('正在验证认证信息...');
                showLoading('case');
                
                // Detect range and load case data
                const caseRange = await detectSheetRange(apiKey, sheetId, sheetNames.case);
                await loadDataWithRange('case', apiKey, sheetId, caseRange);
                
                // If successful, show tabs and hide config
                isAuthenticated = true;
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('tabNavigation').style.display = 'flex';
                
                console.log('认证成功，已启用所有标签页');
                
            } catch (error) {
                console.error('认证失败:', error);
                showError('case', '认证失败: ' + error.message);
            }
        }

        // Show error message
        function showError(tabName, message) {
            const errorDiv = document.getElementById(tabName + 'Error');
            errorDiv.innerHTML = `<strong>错误:</strong> ${message}`;
            errorDiv.style.display = 'block';
            document.getElementById(tabName + 'Loading').style.display = 'none';
            document.getElementById(tabName + 'DataContainer').style.display = 'none';
            document.getElementById(tabName + 'Stats').style.display = 'none';
        }

        // Hide error message
        function hideError(tabName) {
            document.getElementById(tabName + 'Error').style.display = 'none';
        }

        // Show loading state
        function showLoading(tabName) {
            document.getElementById(tabName + 'Loading').style.display = 'block';
            document.getElementById(tabName + 'DataContainer').style.display = 'none';
            document.getElementById(tabName + 'Stats').style.display = 'none';
            hideError(tabName);
        }

        // Generate statistics for different tabs
        function generateStats(tabName, data) {
            const statsContainer = document.getElementById(tabName + 'Stats');
            
            if (!data || data.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            const hasHeader = data[0] && (
                data[0].join('').toLowerCase().includes('processed') ||
                data[0].join('').toLowerCase().includes('resume') ||
                data[0].join('').toLowerCase().includes('match')
            );
            const startIndex = hasHeader ? 1 : 0;
            const totalItems = data.length - startIndex;
            
            let statsHTML = '';
            
            if (tabName === 'case') {
                let processedCount = 0;
                let totalWorkRate = 0;
                let validRates = 0;
                
                for (let i = startIndex; i < data.length; i++) {
                    const processedStatus = data[i][0] || '';
                    if (processedStatus.includes('已') || processedStatus.toLowerCase().includes('yes')) {
                        processedCount++;
                    }
                    
                    const workRate = parseFloat(data[i][6]) || 0;
                    if (workRate > 0) {
                        totalWorkRate += workRate;
                        validRates++;
                    }
                }
                
                const avgWorkRate = validRates > 0 ? (totalWorkRate / validRates).toFixed(2) : 0;
                const completionRate = totalItems > 0 ? ((processedCount / totalItems) * 100).toFixed(1) : 0;

                statsHTML = `
                    <div class="stat-card">
                        <div class="number">${totalItems}</div>
                        <div class="label">总项目数</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${processedCount}</div>
                        <div class="label">已处理项目</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${completionRate}%</div>
                        <div class="label">完成率</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">¥${avgWorkRate}</div>
                        <div class="label">平均工作费率</div>
                    </div>
                `;
            } else if (tabName === 'talent') {
                let expCounts = { '0-2': 0, '3-5': 0, '6-10': 0, '10+': 0 };
                let skillSet = new Set();
                
                for (let i = startIndex; i < data.length; i++) {
                    const experience = data[i][5] || '';
                    const skills = data[i][6] || '';
                    
                    const expNum = parseInt(experience) || 0;
                    if (expNum <= 2) expCounts['0-2']++;
                    else if (expNum <= 5) expCounts['3-5']++;
                    else if (expNum <= 10) expCounts['6-10']++;
                    else expCounts['10+']++;
                    
                    if (skills) {
                        skills.split(/[,，、]/).forEach(skill => {
                            skillSet.add(skill.trim());
                        });
                    }
                }

                statsHTML = `
                    <div class="stat-card">
                        <div class="number">${totalItems}</div>
                        <div class="label">总人才数</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${skillSet.size}</div>
                        <div class="label">技能种类</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${expCounts['10+']}</div>
                        <div class="label">资深人才 (10+年)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${expCounts['0-2']}</div>
                        <div class="label">新手人才 (0-2年)</div>
                    </div>
                `;
            } else if (tabName === 'matching') {
                let highMatches = 0;
                let mediumMatches = 0;
                let lowMatches = 0;
                let totalScore = 0;
                let validScores = 0;
                
                for (let i = startIndex; i < data.length; i++) {
                    // 修正后的列索引 - 去掉了Match ID列
                    const score1 = parseFloat(data[i][4]) || 0;  // Match 1 Score
                    const score2 = parseFloat(data[i][7]) || 0;  // Match 2 Score
                    const score3 = parseFloat(data[i][10]) || 0;  // Match 3 Score
                    
                    [score1, score2, score3].forEach(score => {
                        if (score > 0) {
                            totalScore += score;
                            validScores++;
                            if (score >= 80) highMatches++;
                            else if (score >= 60) mediumMatches++;
                            else lowMatches++;
                        }
                    });
                }
                
                const avgScore = validScores > 0 ? (totalScore / validScores).toFixed(1) : 0;
            
                statsHTML = `
                    <div class="stat-card">
                        <div class="number">${totalItems}</div>
                        <div class="label">总匹配记录</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${highMatches}</div>
                        <div class="label">高分匹配 (≥80)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${mediumMatches}</div>
                        <div class="label">中等匹配 (60-79)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${avgScore}</div>
                        <div class="label">平均匹配分数</div>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = statsHTML;
            statsContainer.style.display = 'grid';
        }

        // 需要更新 formatCellContent 函数以处理新增的字段（移除原文内容处理）
        function formatCellContent(value, columnIndex, tabName) {
            if (!value) return '';
            
            const cellValue = value.toString();
            
            if (tabName === 'case') {
                switch (columnIndex) {
                    case 0: // Processed At
                        const processed = cellValue.toLowerCase();
                        if (processed.includes('已') || processed.includes('yes')) {
                            return `<span class="processed-status processed-yes">✅ ${cellValue}</span>`;
                        } else {
                            return `<span class="processed-status processed-no">⏳ ${cellValue}</span>`;
                        }
                    case 1:
                    case 7: // Timestamps
                        return `<span class="timestamp">${cellValue}</span>`;
                    case 2: // Email Subject
                        return `<span class="email-subject">${cellValue}</span>`;
                    case 3: // Project ID
                        return `<span class="project-id">${cellValue}</span>`;
                    case 4: // Project Title
                        return `<span class="project-title">${cellValue}</span>`;
                    case 5: // Project Description
                        return `<span class="project-description">${cellValue}</span>`;
                    case 6: // Work Rate
                        return `<span class="work-rate">${cellValue}</span>`;
                    case 8:
                    case 9: // Contact info
                        return `<span class="contact-info">${cellValue}</span>`;
                    case 10: // Project Type
                        return `<span class="project-type">${cellValue}</span>`;
                    case 11: // Tech Requirements
                        const skills = cellValue.split(/[,，、]/).slice(0, 5);
                        return `<div class="skill-tags">${skills.map(skill => 
                            `<span class="skill-tag">${skill.trim()}</span>`
                        ).join('')}</div>`;
                    case 12: // Duration
                        return `<span class="project-duration">${cellValue}</span>`;
                    case 13: // Work Style
                        return `<span class="work-style">${cellValue}</span>`;
                    case 14: // Client Company
                        return `<span class="client-company">${cellValue}</span>`;
                    case 15: // Urgency
                        const urgencyClass = cellValue.toLowerCase().includes('紧急') || cellValue.toLowerCase().includes('urgent') ? 'urgent' : 'normal';
                        return `<span class="urgency ${urgencyClass}">${cellValue}</span>`;
                    case 16: // Special Requirements
                        return `<span class="special-requirements">${cellValue}</span>`;
                }
            } else if (tabName === 'talent') {
                switch (columnIndex) {
                    case 0: // Analysis Date
                        return `<span class="timestamp">${cellValue}</span>`;
                    case 2: // Resume ID
                        return `<span class="talent-id">${cellValue}</span>`;
                    case 3: // Full Name
                        return `<span class="project-title">${cellValue}</span>`;
                    case 5: // Experience Years
                        return `<span class="experience-years">${cellValue}年</span>`;
                    case 6: // Skills
                        const skills = cellValue.split(/[,，、]/).slice(0, 5);
                        return `<div class="skill-tags">${skills.map(skill => 
                            `<span class="skill-tag">${skill.trim()}</span>`
                        ).join('')}</div>`;
                    case 13: // Email
                        return `<span class="email-cell">${cellValue}</span>`;
                    case 14: // LinkedIn
                        if (cellValue.startsWith('http')) {
                            return `<a href="${cellValue}" target="_blank">${cellValue}</a>`;
                        }
                        return cellValue;
                }
           } else if (tabName === 'matching') {
                switch (columnIndex) {
                    case 0: // Match_Date
                        return `<span class="timestamp">${cellValue}</span>`;
                    case 1: // Talent_ID
                        return `<span class="talent-id">${cellValue}</span>`;
                    case 2: // Talent_Name
                        return `<span class="project-title">${cellValue}</span>`;
                    case 3:
                    case 5:
                    case 7: // Match 1/2/3 Score (重新映射后的索引)
                        const score = parseFloat(cellValue) || 0;
                        let scoreClass = 'low';
                        if (score >= 80) scoreClass = 'high';
                        else if (score >= 60) scoreClass = 'medium';
                        return `<span class="match-score ${scoreClass}">${cellValue}</span>`;
                    case 4:
                    case 6:
                    case 8: // Match 1/2/3 Name (重新映射后的索引)
                        return `<span class="project-title">${cellValue}</span>`;
                    case 9: // Match Details (重新映射后的索引)
                        return formatMatchDetails(cellValue);
                }
            }
                        
            return cellValue;
        }


        // 格式化匹配详情JSON为压缩的一段话显示
function formatMatchDetails(jsonString) {
    if (!jsonString || jsonString.trim() === '') {
        return '<div class="match-details-compact">📋 暂无匹配详情</div>';
    }
    
    try {
        const data = JSON.parse(jsonString);
        
        if (!data.matchedItems || !Array.isArray(data.matchedItems) || data.matchedItems.length === 0) {
            return '<div class="match-details-compact">📋 暂无匹配项目</div>';
        }
        
        // ✅ 改进：包含reason的显示
        let detailsHtml = '<div class="match-details-with-reason">';
        detailsHtml += '<div>🎯 匹配项目:</div>';
        
        data.matchedItems.slice(0, 3).forEach((match, index) => {
            if (match.name && match.score) {
                detailsHtml += `<div>• ${match.name} (${match.score}分)</div>`;
                if (match.reason) {
                    // ✅ 显示理由
                    detailsHtml += `<div class="match-item-reason">💡 ${match.reason}</div>`;
                }
            }
        });
        
        detailsHtml += '</div>';
        return detailsHtml;
        
    } catch (error) {
        console.error('JSON解析错误:', error);
        return '<div class="match-details-compact match-error">⚠️ 数据解析失败</div>';
    }
}

        // Render table for specific tab with pagination
        // 在renderTable函数中，修改表格渲染部分
            function renderTable(tabName, data) {
                const table = document.getElementById(tabName + 'DataTable');
                
                if (!data || data.length === 0) {
                    table.innerHTML = '<tr><td colspan="15">没有找到数据</td></tr>';
                    updatePagination(tabName, 0, []);
                    return;
                }
            
                // 确定是否有表头
                const hasHeader = data[0] && (
                    data[0].join('').toLowerCase().includes('processed') ||
                    data[0].join('').toLowerCase().includes('resume') ||
                    data[0].join('').toLowerCase().includes('match')
                );
                
                const headerRow = hasHeader ? data[0] : null;
                const dataRows = hasHeader ? data.slice(1) : data;
                
                // 定义要隐藏的列索引（对于matching表）
                const hiddenColumns = tabName === 'matching' ? [3, 6, 9] : []; // Match ID列
                
                // 应用分页
                const currentPageNum = currentPage[tabName];
                const pageSize = getPageSize(tabName);
                const startIndex = (currentPageNum - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const paginatedData = dataRows.slice(startIndex, endIndex);
            
                let html = '';
                
                // 使用预定义的表头（已经去掉了Match ID）
                html += '<thead><tr>';
                predefinedHeaders[tabName].forEach((header) => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead>';
            
                // 创建表格主体
                html += '<tbody>';
                
                if (paginatedData.length === 0) {
                    const colspan = predefinedHeaders[tabName].length;
                    html += `<tr><td colspan="${colspan}" style="text-align: center; padding: 40px; color: #6b7280;">当前页没有数据</td></tr>`;
                } else {
                    for (let i = 0; i < paginatedData.length; i++) {
                        const row = paginatedData[i];
                        if (row && row.some(cell => cell !== undefined && cell !== '')) {
                            html += '<tr>';
                            
                            // 过滤并重新映射列索引
                            let displayColumnIndex = 0;
                            for (let j = 0; j < row.length && displayColumnIndex < predefinedHeaders[tabName].length; j++) {
                                // 跳过隐藏的列
                                if (hiddenColumns.includes(j)) {
                                    continue;
                                }
                                
                                const cellValue = row[j] || '';
                                const formattedValue = formatCellContent(cellValue, displayColumnIndex, tabName);
                                html += `<td>${formattedValue}</td>`;
                                displayColumnIndex++;
                            }
                            html += '</tr>';
                        }
                    }
                }
                html += '</tbody>';
            
                table.innerHTML = html;
                
                // 更新分页控件
                updatePagination(tabName, dataRows.length, dataRows);
            }

        // Get current page size for a tab
        function getPageSize(tabName) {
            const select = document.getElementById(tabName + 'PageSize');
            return parseInt(select.value) || 3;
        }

        // Update pagination controls and info
        function updatePagination(tabName, totalRecords, dataRows) {
            const paginationContainer = document.getElementById(tabName + 'Pagination');
            const paginationInfo = document.getElementById(tabName + 'PaginationInfo');
            const pageInput = document.getElementById(tabName + 'PageInput');
            
            const pageSize = getPageSize(tabName);
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            const currentPageNum = Math.min(currentPage[tabName], totalPages);
            
            // Update current page if it exceeds total pages
            currentPage[tabName] = currentPageNum;
            
            const startRecord = totalRecords > 0 ? (currentPageNum - 1) * pageSize + 1 : 0;
            const endRecord = Math.min(currentPageNum * pageSize, totalRecords);
            
            // Show pagination if there are records
            if (totalRecords > 0) {
                paginationContainer.style.display = 'flex';
                paginationInfo.textContent = `显示第 ${startRecord}-${endRecord} 条，共 ${totalRecords} 条记录`;
                pageInput.value = currentPageNum;
                pageInput.max = totalPages;
                
                // Update button states
                const firstBtn = document.getElementById(tabName + 'FirstBtn');
                const prevBtn = document.getElementById(tabName + 'PrevBtn');
                const nextBtn = document.getElementById(tabName + 'NextBtn');
                const lastBtn = document.getElementById(tabName + 'LastBtn');
                
                firstBtn.disabled = currentPageNum === 1;
                prevBtn.disabled = currentPageNum === 1;
                nextBtn.disabled = currentPageNum === totalPages;
                lastBtn.disabled = currentPageNum === totalPages;
                
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        // Pagination functions
        function goToPage(tabName, pageNum) {
            const dataToUse = filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName];
            const hasHeader = dataToUse[0] && (
                dataToUse[0].join('').toLowerCase().includes('processed') ||
                dataToUse[0].join('').toLowerCase().includes('resume') ||
                dataToUse[0].join('').toLowerCase().includes('match')
            );
            const dataRows = hasHeader ? dataToUse.slice(1) : dataToUse;
            const pageSize = getPageSize(tabName);
            const totalPages = Math.ceil(dataRows.length / pageSize) || 1;
            
            currentPage[tabName] = Math.max(1, Math.min(pageNum, totalPages));
            renderTable(tabName, dataToUse);
        }

        function previousPage(tabName) {
            if (currentPage[tabName] > 1) {
                goToPage(tabName, currentPage[tabName] - 1);
            }
        }

        function nextPage(tabName) {
            const dataToUse = filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName];
            const hasHeader = dataToUse[0] && (
                dataToUse[0].join('').toLowerCase().includes('processed') ||
                dataToUse[0].join('').toLowerCase().includes('resume') ||
                dataToUse[0].join('').toLowerCase().includes('match')
            );
            const dataRows = hasHeader ? dataToUse.slice(1) : dataToUse;
            const pageSize = getPageSize(tabName);
            const totalPages = Math.ceil(dataRows.length / pageSize) || 1;
            
            if (currentPage[tabName] < totalPages) {
                goToPage(tabName, currentPage[tabName] + 1);
            }
        }

        function goToLastPage(tabName) {
            const dataToUse = filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName];
            const hasHeader = dataToUse[0] && (
                dataToUse[0].join('').toLowerCase().includes('processed') ||
                dataToUse[0].join('').toLowerCase().includes('resume') ||
                dataToUse[0].join('').toLowerCase().includes('match')
            );
            const dataRows = hasHeader ? dataToUse.slice(1) : dataToUse;
            const pageSize = getPageSize(tabName);
            const totalPages = Math.ceil(dataRows.length / pageSize) || 1;
            
            goToPage(tabName, totalPages);
        }

        function goToPageInput(tabName) {
            const pageInput = document.getElementById(tabName + 'PageInput');
            const pageNum = parseInt(pageInput.value);
            if (pageNum && pageNum > 0) {
                goToPage(tabName, pageNum);
            }
        }

        function handlePageInputEnter(event, tabName) {
            if (event.key === 'Enter') {
                goToPageInput(tabName);
            }
        }

        function changePageSize(tabName) {
            currentPage[tabName] = 1; // Reset to first page when changing page size
            const dataToUse = filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName];
            renderTable(tabName, dataToUse);
        }

        // Apply filters for specific tab
        function applyFilters(tabName) {
            if (!currentData[tabName] || currentData[tabName].length === 0) return;

            const data = currentData[tabName];
            const hasHeader = data[0] && (
                data[0].join('').toLowerCase().includes('processed') ||
                data[0].join('').toLowerCase().includes('resume') ||
                data[0].join('').toLowerCase().includes('match')
            );
            const startIndex = hasHeader ? 1 : 0;
            
            filteredData[tabName] = hasHeader ? [data[0]] : [];

            for (let i = startIndex; i < data.length; i++) {
                const row = data[i];
                let include = true;

                if (tabName === 'case') {
                    const processedFilter = document.getElementById('caseProcessedFilter').value;
                    const projectFilter = document.getElementById('caseProjectFilter').value.toLowerCase();
                    const contactFilter = document.getElementById('caseContactFilter').value.toLowerCase();
                    const dateFilter = document.getElementById('caseDateFilter').value;

                    if (processedFilter) {
                        const processedStatus = (row[0] || '').toString();
                        if (processedFilter === '已处理') {
                            if (!processedStatus.includes('已') && !processedStatus.toLowerCase().includes('yes')) {
                                include = false;
                            }
                        } else if (processedFilter === '未处理') {
                            if (processedStatus.includes('已') || processedStatus.toLowerCase().includes('yes')) {
                                include = false;
                            }
                        }
                    }

                    if (projectFilter && include) {
                        const projectId = (row[3] || '').toString().toLowerCase();
                        if (!projectId.includes(projectFilter)) include = false;
                    }

                    if (contactFilter && include) {
                        const contactPerson = (row[8] || '').toString().toLowerCase();
                        if (!contactPerson.includes(contactFilter)) include = false;
                    }

                    if (dateFilter && include) {
                        const startTime = row[7] || '';
                        if (startTime && !startTime.includes(dateFilter)) include = false;
                    }
                } else if (tabName === 'talent') {
                    const skillFilter = document.getElementById('talentSkillFilter').value.toLowerCase();
                    const locationFilter = document.getElementById('talentLocationFilter').value.toLowerCase();
                    const experienceFilter = document.getElementById('talentExperienceFilter').value;
                    const nameFilter = document.getElementById('talentNameFilter').value.toLowerCase();

                    if (skillFilter && include) {
                        const skills = (row[6] || '').toString().toLowerCase();
                        if (!skills.includes(skillFilter)) include = false;
                    }

                    if (locationFilter && include) {
                        const location = (row[11] || '').toString().toLowerCase();
                        if (!location.includes(locationFilter)) include = false;
                    }

                    if (experienceFilter && include) {
                        const experience = parseInt(row[5]) || 0;
                        if (experienceFilter === '0-2' && (experience < 0 || experience > 2)) include = false;
                        else if (experienceFilter === '3-5' && (experience < 3 || experience > 5)) include = false;
                        else if (experienceFilter === '6-10' && (experience < 6 || experience > 10)) include = false;
                        else if (experienceFilter === '10+' && experience <= 10) include = false;
                    }

                    if (nameFilter && include) {
                        const name = (row[3] || '').toString().toLowerCase();
                        if (!name.includes(nameFilter)) include = false;
                    }
                } else if (tabName === 'matching') {
                    const talentFilter = document.getElementById('matchingTalentFilter').value.toLowerCase();
                    const scoreFilter = parseInt(document.getElementById('matchingScoreFilter').value) || 0;
                    const dateFilter = document.getElementById('matchingDateFilter').value;
                
                    if (talentFilter && include) {
                        const talentId = (row[1] || '').toString().toLowerCase();
                        if (!talentId.includes(talentFilter)) include = false;
                    }
                
                    if (scoreFilter && include) {
                        // 修正后的列索引 - 去掉了Match ID列
                        const score1 = parseFloat(row[4]) || 0;  // Match 1 Score
                        const score2 = parseFloat(row[7]) || 0;  // Match 2 Score
                        const score3 = parseFloat(row[10]) || 0;  // Match 3 Score
                        if (Math.max(score1, score2, score3) < scoreFilter) include = false;
                    }
                
                    if (dateFilter && include) {
                        const matchDate = row[0] || '';
                        if (matchDate && !matchDate.includes(dateFilter)) include = false;
                    }
                }

                if (include) {
                    filteredData[tabName].push(row);
                }
            }

            currentPage[tabName] = 1; // Reset to first page when applying filters
            renderTable(tabName, filteredData[tabName]);
            generateStats(tabName, filteredData[tabName]);
        }

        // Clear filters for specific tab
        function clearFilters(tabName) {
            if (tabName === 'case') {
                document.getElementById('caseProcessedFilter').value = '';
                document.getElementById('caseProjectFilter').value = '';
                document.getElementById('caseContactFilter').value = '';
                document.getElementById('caseDateFilter').value = '';
            } else if (tabName === 'talent') {
                document.getElementById('talentSkillFilter').value = '';
                document.getElementById('talentLocationFilter').value = '';
                document.getElementById('talentExperienceFilter').value = '';
                document.getElementById('talentNameFilter').value = '';
            } else if (tabName === 'matching') {
                document.getElementById('matchingTalentFilter').value = '';
                document.getElementById('matchingQueryFilter').value = '';
                document.getElementById('matchingScoreFilter').value = '';
                document.getElementById('matchingDateFilter').value = '';
            }
            
            filteredData[tabName] = [...currentData[tabName]];
            currentPage[tabName] = 1; // Reset to first page when clearing filters
            renderTable(tabName, currentData[tabName]);
            generateStats(tabName, currentData[tabName]);
        }

        // Export to CSV for specific tab
        function exportToCSV(tabName) {
            const dataToExport = filteredData[tabName].length > 0 ? filteredData[tabName] : currentData[tabName];
            
            if (!dataToExport || dataToExport.length === 0) {
                alert('没有数据可以导出');
                return;
            }

            let csvContent = '';
            dataToExport.forEach(row => {
                const csvRow = row.map(cell => {
                    const cleanCell = (cell || '').toString().replace(/<[^>]*>/g, '').replace(/"/g, '""');
                    return `"${cleanCell}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${tabName}_数据_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Load data for specific tab with automatic range detection
        async function loadData(tabName) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sheetId = document.getElementById('sheetId').value.trim();

            if (!apiKey || !sheetId) {
                showError(tabName, '请输入API密钥和表格ID');
                return;
            }

            showLoading(tabName);

            try {
                // Auto-detect range for the specific sheet
                const sheetRange = await detectSheetRange(apiKey, sheetId, sheetNames[tabName]);
                await loadDataWithRange(tabName, apiKey, sheetId, sheetRange);
                
            } catch (error) {
                console.error(`加载${tabName}数据时出错:`, error);
                let errorMessage = `加载${tabName}数据失败: ` + error.message;
                
                if (error.message.includes('403')) {
                    errorMessage += '<br><br>可能的解决方案:<br>1. 检查API密钥是否正确<br>2. 确保已启用Google Sheets API<br>3. 检查API密钥的权限设置';
                } else if (error.message.includes('400')) {
                    errorMessage += '<br><br>可能的解决方案:<br>1. 检查表格ID是否正确<br>2. 确保表格是公开可访问的<br>3. 检查工作表名称是否正确';
                } else if (error.message.includes('404')) {
                    errorMessage += '<br><br>表格未找到，请检查表格ID是否正确';
                } else if (error.message.includes('未找到名为')) {
                    errorMessage += `<br><br>请确保表格中包含名为 "${sheetNames[tabName]}" 的工作表`;
                }
                
                showError(tabName, errorMessage);
            }
        }

        // Load data with specific range
        async function loadDataWithRange(tabName, apiKey, sheetId, sheetRange) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (!result.values || result.values.length === 0) {
                throw new Error(`工作表 "${sheetNames[tabName]}" 中没有找到数据`);
            }

            // Filter out completely empty rows
            const filteredData = result.values.filter(row => 
                row && row.some(cell => cell !== undefined && cell !== null && cell.toString().trim() !== '')
            );

            if (filteredData.length === 0) {
                throw new Error(`工作表 "${sheetNames[tabName]}" 中没有找到有效数据`);
            }

            currentData[tabName] = filteredData;
            filteredData[tabName] = [...filteredData];
            
            generateStats(tabName, filteredData);
            renderTable(tabName, filteredData);

            document.getElementById(tabName + 'Loading').style.display = 'none';
            document.getElementById(tabName + 'DataContainer').style.display = 'block';
            
            console.log(`${tabName} 数据加载成功 (工作表: ${sheetNames[tabName]}):`, filteredData.length, '行数据');
        }

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            
            // Add keyboard shortcuts
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isAuthenticated) {
                    authenticateAndLoad();
                }
            });

            // Add filter enter key events for each tab
            ['case', 'talent', 'matching'].forEach(tab => {
                const filterIds = {
                    case: ['caseProcessedFilter', 'caseProjectFilter', 'caseContactFilter', 'caseDateFilter'],
                    talent: ['talentSkillFilter', 'talentLocationFilter', 'talentExperienceFilter', 'talentNameFilter'],
                    matching: ['matchingTalentFilter', 'matchingQueryFilter', 'matchingScoreFilter', 'matchingDateFilter']
                };
                
                filterIds[tab].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                applyFilters(tab);
                            }
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
